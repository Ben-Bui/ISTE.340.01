<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baldur Gate 3 Character Creator</title>
    <link rel="stylesheet" href="styles.css">
    <script src="data.js"></script>
    <script src="cookies.js"></script>
</head>
<body>
    <h1>Baldur Gate 3 Character Creator</h1>

    <!-- Character Creation Form -->
    <form id="character-form">
        <div id="form-container"></div>
        <p id="result"></p>
        <button type="button" id="reset-btn">Start Over</button>
    </form>

    <hr>

    <!-- User Information Form -->
    <h2>Enter Your Information</h2>
    <form id="user-form">
        <label for="name">Name:</label>
        <input type="text" id="name" required>
        <span class="error" id="name-error"></span>
        <br>

        <label for="email">Email:</label>
        <input type="email" id="email" required>
        <span class="error" id="email-error"></span>
        <br>

        <label for="age">Age:</label>
        <input type="number" id="age" min="13" required>
        <span class="error" id="age-error"></span>
        <br>

        <label>
            <input type="checkbox" id="terms" required>
            I agree to the terms and conditions
        </label>
        <span class="error" id="terms-error"></span>
        <br>

        <button type="submit">Submit</button>
    </form>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            /*** BROWSER CHECK & REDIRECT ***/
            const supportedBrowsers = ["Chrome", "Firefox", "Edge", "Safari"];
            let isSupported = false;
            let userAgent = navigator.userAgent;

            if (/Chrome/.test(userAgent) && !/Edge/.test(userAgent)) {
                isSupported = true;
            } else if (/Firefox/.test(userAgent)) {
                isSupported = true;
            } else if (/Safari/.test(userAgent) && !/Chrome/.test(userAgent)) {
                isSupported = true;
            } else if (/Edge/.test(userAgent)) {
                isSupported = true;
            }

            if (!isSupported) {
                window.location.href = "browser-warning.html";
            }

            /*** CHARACTER CREATION LOGIC ***/
            const formContainer = document.getElementById("form-container");
            const result = document.getElementById("result");
            const resetBtn = document.getElementById("reset-btn");

            class DropdownCreator {
                constructor(question, options, parentKey) {
                    this.question = question;
                    this.options = options;
                    this.parentKey = parentKey;
                }

                createDropdown() {
                    let questionElement = document.createElement("p");
                    questionElement.textContent = this.question;

                    let select = document.createElement("select");
                    select.setAttribute("data-key", this.parentKey);
                    select.addEventListener("change", () => this.handleSelection(select));

                    // Add blank default option
                    let blankOption = document.createElement("option");
                    blankOption.value = "";
                    blankOption.textContent = "Select an option...";
                    blankOption.disabled = true;
                    blankOption.selected = true;
                    select.appendChild(blankOption);

                    // Populate dropdown with choices
                    this.options.forEach(option => {
                        let opt = document.createElement("option");
                        opt.value = option;
                        opt.textContent = option;
                        select.appendChild(opt);
                    });

                    formContainer.appendChild(questionElement);
                    formContainer.appendChild(select);
                }

                handleSelection(select) {
                    let selectedValue = select.value;

                    // Remove all elements that were added after this selection
                    while (select.nextSibling) {
                        formContainer.removeChild(select.nextSibling);
                    }

                    if (characterData[selectedValue]) {
                        let nextQuestion = characterData[selectedValue][0];
                        let nextOptions = characterData[selectedValue].slice(1);
                        new DropdownCreator(nextQuestion, nextOptions, selectedValue).createDropdown();
                    } else {
                        displayResult();
                    }
                }
            }

            function displayResult() {
                let selections = {};
                let keys = ["Race", "Class", "Background", "Weapon"];
                let index = 0;

                formContainer.querySelectorAll("select").forEach(select => {
                    if (index < keys.length) {
                        selections[keys[index]] = select.value;
                        index++;
                    }
                });

                let resultText = "";
                for (let key in selections) {
                    resultText += `${key}: ${selections[key]}\n`;
                }

                result.textContent = resultText.trim();
                setCookie("characterSelection", JSON.stringify(selections), 7);
                localStorage.setItem("characterSelection", JSON.stringify(selections));

                // Fade in the result
                fadeIn(result);
            }

            function fadeIn(element) {
                let opacity = 0;
                element.style.opacity = opacity;
                element.style.display = "block";

                function animate() {
                    opacity += 0.05;
                    element.style.opacity = opacity;
                    if (opacity < 1) {
                        requestAnimationFrame(animate);
                    }
                }
                animate();
            }

            resetBtn.addEventListener("click", function() {
                formContainer.innerHTML = "";
                result.textContent = "";
                new DropdownCreator(characterData.init[0], characterData.init.slice(1), "init").createDropdown();
            });

            // Initialize the first dropdown
            new DropdownCreator(characterData.init[0], characterData.init.slice(1), "init").createDropdown();

            /*** USER FORM VALIDATION ***/
            const userForm = document.getElementById("user-form");

            userForm.addEventListener("submit", function(event) {
                event.preventDefault();
                let isValid = true;

                // Name Validation
                const name = document.getElementById("name").value.trim();
                if (name.length < 2) {
                    document.getElementById("name-error").textContent = "Name must be at least 2 characters.";
                    isValid = false;
                } else {
                    document.getElementById("name-error").textContent = "";
                }

                // Email Validation
                const email = document.getElementById("email").value.trim();
                const emailPattern = /^[^@\s]+@[^@\s]+\.[a-zA-Z]{2,}$/;
                if (!emailPattern.test(email)) {
                    document.getElementById("email-error").textContent = "Enter a valid email.";
                    isValid = false;
                } else {
                    document.getElementById("email-error").textContent = "";
                }

                // Age Validation
                const age = parseInt(document.getElementById("age").value, 10);
                if (isNaN(age) || age < 13) {
                    document.getElementById("age-error").textContent = "You must be at least 13 years old.";
                    isValid = false;
                } else {
                    document.getElementById("age-error").textContent = "";
                }

                // Terms and Conditions Validation
                if (!document.getElementById("terms").checked) {
                    document.getElementById("terms-error").textContent = "You must agree to the terms.";
                    isValid = false;
                } else {
                    document.getElementById("terms-error").textContent = "";
                }

                if (isValid) {
                    alert("Form submitted successfully!");
                    userForm.reset();
                }
            });
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Baldur's Gate Character Creation</title>
    <link rel="stylesheet" href="styles.css">
    <script>
        // Browser detection
        if (!document.getElementById) {
            window.location = "https://www.mozilla.org/en-US/firefox/new/";
        }

        var ie7 = false;

        function $(id) {
            return document.getElementById(id);
        }
    </script>

    <!--[if lt IE 8]>
    <script>
        var ie7 = true;
    </script>
    <![endif]-->

    <script src="data.js"></script>
    <script src="cookies.js"></script>

    <script>
        var selectedCharacter = {};
        var opacity = 0;

        function animation(dom) {
            if (dom.nodeName === "IMG") {
                if (isNaN(dom.style.opacity)) {
                    dom.style.opacity = 0;
                }
                if (dom.style.opacity < 1.0) {
                    dom.style.opacity = opacity;
                    opacity += 0.02;
                    requestAnimationFrame(() => animation(dom));
                }
            } else {
                var hold = dom.parentNode.nextSibling;
                if (isNaN(parseInt(hold.style.marginLeft))) {
                    hold.style.marginLeft = "5px";
                }

                let maxMargin = hold == $("container").childNodes[2] ? 100 :
                                hold == $("container").childNodes[3] ? 200 : 300;
                
                if (parseInt(hold.style.marginLeft) < maxMargin) {
                    hold.style.marginLeft = parseInt(hold.style.marginLeft) + 3 + 'px';
                    requestAnimationFrame(() => animation(dom));
                }
            }
        }

        function validate() {
            var errMsg = "";
            var start = "Please complete the following fields: ";

            ["char-name", "first-name", "last-name", "age"].forEach(id => {
                let field = $(id);
                if (!field.value) {
                    errMsg += field.name + ", ";
                    field.style.border = "solid red";
                } else {
                    field.style.border = "2px inset #EBE9ED";
                    if (localStorage) {
                        if (!localStorage.getItem(id)) {
                            localStorage.setItem(id, field.value);
                        }
                    } else {
                        if (GetCookie(id) == null) {
                            SetCookie(id, field.value);
                        }
                    }
                }
            });

            if (errMsg != "") {
                var feedbackDiv = $("feedback-div");
                feedbackDiv.innerHTML = `<p class='feedback'>${start + errMsg}</p>`;
                feedbackDiv.style.display = "block";
                return false;
            }

            displayFinalSelection();
            return true;
        }

        function construct(dom) {
            var hold = typeof dom == "string" ? characterData[dom] : characterData[dom.value];
            if (hold != undefined) {
                var div = document.createElement('div');
                div.setAttribute('class', 'divContainer');
                $('container').appendChild(div);

                var sel = document.createElement('select');
                sel.setAttribute('name', 'selectmenu');
                sel.setAttribute('onchange', 'construct(this);animation(this);');

                for (var i = 1; i < hold.length; i++) {
                    var opt = document.createElement('option');
                    if (i == 1) {
                        opt.setAttribute('disabled', 'disabled');
                        opt.setAttribute('selected', 'selected');
                    }
                    opt.setAttribute('value', hold[i]);
                    opt.appendChild(document.createTextNode(hold[i]));
                    sel.appendChild(opt);
                }
                div.appendChild(sel);
            } else {
                selectedCharacter[dom.name] = dom.value;
                createCharacterForm();
            }
        }

        function createCharacterForm() {
            var divForm = document.createElement('div');
            divForm.setAttribute('class', 'divContainer');

            var feedbackDiv = document.createElement('div');
            feedbackDiv.setAttribute('id', 'feedback-div');
            divForm.appendChild(feedbackDiv);

            $('container').appendChild(divForm);

            var form = document.createElement('form');
            form.setAttribute('method', 'post');
            form.setAttribute('id', 'character-form');
            form.setAttribute('action', 'project1.html');
            form.setAttribute('onsubmit', 'return validate();');

            addTextInput(form, "Character Name", "char-name");
            addTextInput(form, "First Name", "first-name");
            addTextInput(form, "Last Name", "last-name");
            addTextInput(form, "Age", "age", "number");

            var submit = document.createElement('input');
            submit.setAttribute('type', 'submit');
            submit.setAttribute('value', 'Create Character');
            form.appendChild(submit);

            divForm.appendChild(form);

            addResetButton();
        }

        function addTextInput(form, labelText, id, type = "text") {
            var p = document.createElement('p');
            var label = document.createElement('label');
            label.appendChild(document.createTextNode(labelText));
            label.setAttribute('for', id);

            var input = document.createElement('input');
            input.setAttribute('name', id);
            input.setAttribute('id', id);
            input.setAttribute('type', type);
            input.setAttribute('size', '16');
            input.setAttribute('maxlength', '16');

            label.appendChild(input);
            p.appendChild(label);
            form.appendChild(p);
        }

        function addResetButton() {
            var resetButton = document.createElement('button');
            resetButton.textContent = "Start Over";
            resetButton.onclick = function() {
                $('container').innerHTML = '';
                selectedCharacter = {};
                construct('init');
            };
            $('container').appendChild(resetButton);
        }

        function displayFinalSelection() {
            var resultDiv = $("result");
            resultDiv.innerHTML = `<p>You created a ${selectedCharacter["Race"] || "mysterious being"} ${selectedCharacter["Class"] || "adventurer"} named ${$("char-name").value}!</p>`;
        }

    </script>
</head>
<body onload="construct('init')">
    <div id="result"></div>
    <div id="container"></div>
</body>
</html>
